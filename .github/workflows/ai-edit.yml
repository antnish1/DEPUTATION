name: AI Auto Edit

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      filename:
        description: "File to edit (example: index.html)"
        required: true
        default: "index.html"
      instruction:
        description: "What should AI change?"
        required: true
        default: "Add feature without removing existing functionality"

jobs:
  ai-edit:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Read File
        run: |
          FILE="${{ github.event.inputs.filename }}"
          if [ ! -f "$FILE" ]; then
            echo "File does not exist!"
            exit 1
          fi

          cp "$FILE" "$FILE.backup"
          CONTENT=$(cat "$FILE" | jq -Rs .)

          echo "FILE=$FILE" >> $GITHUB_ENV
          echo "CONTENT=$CONTENT" >> $GITHUB_ENV

      - name: Send to OpenAI
        run: |
          RESPONSE=$(curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.OPENAI_API_KEY }}" \
            -d "{
              \"model\": \"gpt-4o-mini\",
              \"messages\": [
                {\"role\": \"system\", \"content\": \"You are a senior web developer. Return ONLY the full updated file code. Never remove existing functionality unless explicitly told.\"},
                {\"role\": \"user\", \"content\": \"Instruction: ${{ github.event.inputs.instruction }}\n\nFile Content:\n$CONTENT\"}
              ]
            }")

          UPDATED=$(echo $RESPONSE | jq -r '.choices[0].message.content')

          # Safety checks
          if [ -z "$UPDATED" ]; then
            echo "AI returned empty content. Aborting."
            exit 1
          fi

          LENGTH=$(echo "$UPDATED" | wc -c)

          if [ "$LENGTH" -lt 100 ]; then
            echo "AI output suspiciously small. Aborting."
            exit 1
          fi

          echo "$UPDATED" > "$FILE"

      - name: Commit and Push
        run: |
          git config user.name "AI Bot"
          git config user.email "actions@github.com"
          git add "$FILE"
          git commit -m "AI update: ${{ github.event.inputs.instruction }}" || echo "No changes to commit"
          git push
